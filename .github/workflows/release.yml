on:
  repository_dispatch:
    types: release
  workflow_dispatch:
    inputs:
      version:
        description: 'Addon version (e.g., 1.0.1)'
        required: true
        type: string
  release:
    types: [published]

name: Release

permissions: {}
jobs:
  release:
    permissions:
      contents: write
      pull-requests: write

    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        ref: main
        token: ${{ secrets.GITHUB_TOKEN }}
    - name: Set variables
      id: version
      run: |
        if [ "${{ github.event_name }}" == "repository_dispatch" ]; then
          VERSION="${{ github.event.client_payload.version }}"
        elif [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          VERSION="${{ github.event.inputs.version }}"
        elif [ "${{ github.event_name }}" == "release" ]; then
          VERSION="${{ github.event.release.tag_name }}"
          # Remove 'v' prefix if present
          VERSION="${VERSION#v}"
        else
          echo "Unknown event type: ${{ github.event_name }}"
          exit 1
        fi
        echo "addon=${VERSION}" >> "$GITHUB_OUTPUT"
        echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
        echo "Using version: ${VERSION}"
    - name: Set version and update release
      run: | 
        jq '.version = "${{ steps.version.outputs.addon }}"' frpc/config.json > frpc/config.json.tmp
        mv frpc/config.json.tmp frpc/config.json
    
    - name: Commit version update
      if: github.event_name != 'release'
      uses: stefanzweifel/git-auto-commit-action@v7
      with:
        commit_message: "v${{ steps.version.outputs.addon }}"
    
    - name: Create GitHub Release
      if: github.event_name != 'release'
      uses: ncipollo/release-action@v1
      with:
        tag: "v${{ steps.version.outputs.addon }}"
        body: "Release version ${{ steps.version.outputs.addon }}"
        token: ${{ secrets.GITHUB_TOKEN }}

