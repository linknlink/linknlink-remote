name: Build and Push Docker Images

on:
  push:
    branches:
      - main
    paths:
      - 'frpc/**'
      - '.github/workflows/**'
      - 'repository.json'
  release:
    types:
      - published
  workflow_dispatch:
    inputs:
      skip_architectures:
        description: 'Skip specific architectures (comma-separated, e.g. aarch64,armhf)'
        required: false
        type: string
      version_tag:
        description: 'Override version tag (leave empty to use config.json version)'
        required: false
        type: string

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository_owner }}/linknlink-remote-frpc

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      contents: read
      packages: write

    strategy:
      fail-fast: false
      matrix:
        arch:
          - name: aarch64
            platform: linux/arm64
          - name: amd64
            platform: linux/amd64
          - name: armv7
            platform: linux/arm/v7

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract version from config.yaml
        id: version
        run: |
          if [ -f frpc/config.yaml ]; then
            VERSION=$(grep -E '^version:' frpc/config.yaml | sed 's/version: //' | tr -d ' "')
          elif [ -f frpc/config.json ]; then
            VERSION=$(grep -o '"version": "[^"]*' frpc/config.json | grep -o '[^"]*$')
          else
            echo "Error: Neither config.yaml nor config.json found"
            exit 1
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION"

      - name: Determine tags
        id: tags
        run: |
          if [ "${{ github.event_name }}" == "release" ]; then
            TAG="${{ github.event.release.tag_name }}"
          elif [ "${{ github.ref }}" == "refs/heads/main" ]; then
            TAG="latest"
          else
            TAG="${{ github.ref_name }}-${{ github.sha }}"
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Using tag: $TAG"

      - name: Build and push architecture-specific image
        run: |
          ARCH=${{ matrix.arch.name }}
          PLATFORM=${{ matrix.arch.platform }}
          IMAGE_TAG="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${ARCH}"
          
          # Map architecture names for TARGETARCH
          case ${ARCH} in
            aarch64) TARGETARCH="arm64" ;;
            amd64) TARGETARCH="amd64" ;;
            armv7) TARGETARCH="arm" ;;
            *) TARGETARCH="${ARCH}" ;;
          esac
          
          echo "Building ${ARCH} image for platform ${PLATFORM} (TARGETARCH=${TARGETARCH})..."
          
          docker buildx build \
            --platform ${PLATFORM} \
            --file ./frpc/Dockerfile \
            --build-arg BUILD_FROM=ghcr.io/hassio-addons/base:18.2.1 \
            --build-arg TARGETARCH=${TARGETARCH} \
            --tag ${IMAGE_TAG} \
            --push \
            --cache-from type=gha,scope=${ARCH} \
            --cache-to type=gha,mode=max,scope=${ARCH} \
            --provenance=false \
            --sbom=false \
            ./frpc
          
          echo "âœ“ Built and pushed ${IMAGE_TAG}"
        timeout-minutes: 30

      - name: Push additional tags for this architecture
        run: |
          ARCH=${{ matrix.arch.name }}
          BASE_TAG="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${ARCH}"
          
          # Wait for image to be available
          sleep 3
          
          echo "Creating additional tags for ${ARCH}..."
          
          # Create version tag
          docker pull "$BASE_TAG"
          docker tag "$BASE_TAG" "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }}-${ARCH}"
          docker push "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }}-${ARCH}"
          
          # Create latest tag if on main branch
          if [ "${{ github.ref }}" == "refs/heads/main" ]; then
            docker tag "$BASE_TAG" "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest-${ARCH}"
            docker push "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest-${ARCH}"
          fi
          
          echo "âœ“ Successfully created all tags for ${ARCH}"

      - name: Summary
        if: matrix.arch.name == 'amd64'
        run: |
          echo "## ðŸ³ Docker Images Built" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Architecture-specific tags (for Home Assistant):" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:aarch64\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:amd64\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:armv7\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Home Assistant config:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`yaml" >> $GITHUB_STEP_SUMMARY
          echo "image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/{arch}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

